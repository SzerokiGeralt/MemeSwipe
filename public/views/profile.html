<!DOCTYPE html>
<html>
<head>
    <title>Profile</title>
    <link rel="stylesheet" type="text/css" href="/public/styles/main.css">
    <link rel="stylesheet" type="text/css" href="/public/styles/profile.css">
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <nav class="top desktop-only anchor">
        <ul class="left">
        <?php if (isset($_SESSION['user_id'])): ?>
            <li>Lvl <?php echo htmlspecialchars($ownStats['level'] ?? 'N/A'); ?> <meter id="disk_d" min="0" max="1" value="<?php echo ($ownStats['expPercentage'] ?? 0); ?>"></meter></li>
            <li><?php echo number_format($ownStats['diamonds'] ?? 0); ?> ðŸ’Ž</li>
            <li><?php echo $ownStats['streak'] ?? 0; ?> <?php echo ($ownStats['streakActive'] ?? false) ? 'ðŸ”¥' : 'ðŸ§Š'; ?></li>
        <?php endif; ?>
        </ul>
        <ul class="right">
            <li><a href="/dashboard">Swipe<span class="material-symbols-outlined">home</span></a></li>
            <li><a href="/quests">Quests<span class="material-symbols-outlined">trophy</span></a></li>
            <li><a href="/leaders">Leaders<span class="material-symbols-outlined">leaderboard</span></a></li>
            <li><a href="/upload">Upload<span class="material-symbols-outlined">upload</span></a></li>
            <li><a href="/profile">Profile<span class="material-symbols-outlined">person</span></a></li>
        </ul>
    </nav>
    <nav class="top mobile-only anchor">
        <ul>
            <?php if (isset($_SESSION['user_id'])): ?>
            <li>Lvl <?php echo htmlspecialchars($ownStats['level'] ?? 'N/A'); ?> <meter min="0" max="1" value="<?php echo ($ownStats['expPercentage'] ?? 0); ?>"></meter></li>
            <li><?php echo number_format($ownStats['diamonds'] ?? 0); ?> ðŸ’Ž</li>
            <li><?php echo $ownStats['streak'] ?? 0; ?> <?php echo ($ownStats['streakActive'] ?? false) ? 'ðŸ”¥' : 'ðŸ§Š'; ?></li>
            <?php endif; ?>
        </ul>
    </nav>
    <main class="scrollable <?php echo ($stats['has_golden_profile'] ?? false) ? 'golden-profile' : ''; ?>">
        <div class="profile-header">
            <div class="profile-image-container <?php echo ($stats['has_avatar_frame'] ?? false) ? 'vip-frame' : ''; ?>">
                <img class="profile-image" src="<?php echo $user['profile_photo'] ?? 'https://picsum.photos/400/400'; ?>">
                <?php if ($stats['has_vip_badge'] ?? false): ?>
                    <span class="vip-crown" title="VIP Member">ðŸ‘‘</span>
                <?php endif; ?>
            </div>
            <h1>
                <?php echo htmlspecialchars($user['username']) ?? 'User'; ?>
                <?php if ($stats['has_vip_badge'] ?? false): ?>
                    <span class="vip-badge" title="VIP">âœ¨</span>
                <?php endif; ?>
            </h1>
            <p>Level <?php echo $stats['level'] ?? 1 ?></p>
            <p>Streak: <?php echo $stats['streak'] ?? 0 ?> <?php echo ($stats['streakActive'] ?? false) ? 'ðŸ”¥' : 'ðŸ§Š'; ?></p>
            <p>Diamonds: <?php echo number_format($stats['diamonds'] ?? 0); ?> ðŸ’Ž</p>
            <p>Last login date: <?php echo htmlspecialchars($stats['last_active_date'] ?? 'N/A'); ?></p>
            
            <?php if ($isOwnProfile ?? false): ?>
                <div style="display: flex; gap: 1rem; justify-content: center; margin: 1rem 0;">
                    <a href="/profile/edit" style="background-color: var(--VibrantOrange); color: white; padding: 10px 20px; border-radius: 4px; text-decoration: none;">Edit Profile</a>
                    <a href="/logout" style="background-color: var(--LightGray); color: var(--Background); padding: 10px 20px; border-radius: 4px; text-decoration: none;">Logout</a>
                </div>
            <?php endif; ?>
        </div>
        
        <div class="selection-bar">
            <button class="tab-button active" data-tab="stats">Stats</button>
            <button class="tab-button" data-tab="badges">Badges</button>
            <button class="tab-button" data-tab="collection">Collection</button>
        </div>    
        <div class="tab-content stats active">
            <div class="stats-grid">
                <p class="stats-item">Longest streak: <?php echo $stats['longest_streak'] ?? 0; ?></p>
                <p class="stats-item">Posts: <?php echo $stats['posts_count'] ?? 0; ?></p>
                <p class="stats-item">Experience: <?php echo $stats['experience'] ?? 0; ?> XP</p>
                <p class="stats-item">Experience to next level: <?php echo $stats['expToNextLevel'] ?? 0; ?> XP</p>
            </div>
        </div>
        <div class="tab-content badges">
            <div class="badges-grid">
                <?php if (!empty($badges)): ?>
                    <?php foreach ($badges as $badge): ?>
                        <div class="badge-item">
                            <p><?php echo htmlspecialchars($badge['name']); ?></p>
                            <img src="<?php echo htmlspecialchars($badge['icon']); ?>" alt="Badge Icon">
                            <p><?php echo htmlspecialchars($badge['description']); ?></p>
                        </div>
                    <?php endforeach; ?>
                <?php endif; ?>
                <?php if (empty($badges) && !($stats['has_vip_badge'] ?? false) && !($stats['has_golden_profile'] ?? false) && !($stats['has_avatar_frame'] ?? false) && !($stats['has_cooldown_reducer'] ?? false)): ?>
                    <p class="no-badges">No badges yet. Keep playing to earn badges!</p>
                <?php endif; ?>
            </div>
        </div>
        <div class="tab-content collection">
            <?php if (!empty($posts)): ?>
                <div class="posts-grid">
                    <?php foreach ($posts as $post): ?>
                        <div class="post-item">
                            <img src="<?php echo htmlspecialchars($post['image']); ?>" alt="Meme Image">
                            <p><?php echo htmlspecialchars("Upvotes : ".$post['upvotes']); ?></p>
                            <p><?php echo htmlspecialchars("Downvotes : ".$post['downvotes']); ?></p>
                        </div>
                    <?php endforeach; ?>
                </div>
            <?php endif; ?>
            <?php if (empty($posts)): ?>
                <p class="no-posts">No posts uploaded yet. Share your memes to see them here!</p>
            <?php endif; ?>
        </div>
        
        <script>
            // Tab switching functionality
            document.addEventListener('DOMContentLoaded', function() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        
                        // Remove active class from all buttons and contents
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        // Add active class to clicked button and corresponding content
                        this.classList.add('active');
                        document.querySelector('.tab-content.' + targetTab).classList.add('active');
                    });
                });
            });
        </script>

        <!-- Streak Extended Popup -->
        <div id="streakExtendedPopup" class="popup-overlay">
            <div class="popup-content streak-success">
                <div class="popup-icon">ðŸ”¥</div>
                <h2>STREAK EXTENDED!</h2>
                <p id="streakExtendedMessage">Your streak is now 5 days!</p>
                <p class="streak-bonus">Keep it up!</p>
                <button id="streakExtendedClose" class="popup-btn">Nice!</button>
            </div>
        </div>

        <!-- Streak Lost Popup -->
        <div id="streakLostPopup" class="popup-overlay">
            <div class="popup-content streak-lost">
                <div class="popup-icon">ðŸ§Š</div>
                <h2>STREAK LOST!</h2>
                <p id="streakLostMessage">You lost your 7 day streak...</p>
                <p class="streak-restart">Starting fresh with day 1!</p>
                <button id="streakLostClose" class="popup-btn">Start Again</button>
            </div>
        </div>

        <!-- New Streak Popup -->
        <div id="newStreakPopup" class="popup-overlay">
            <div class="popup-content streak-new">
                <div class="popup-icon">âœ¨</div>
                <h2>WELCOME!</h2>
                <p id="newStreakMessage">Your streak begins today!</p>
                <p class="streak-tip">Come back tomorrow to keep it going!</p>
                <button id="newStreakClose" class="popup-btn">Let's Go!</button>
            </div>
        </div>

        <?php if (isset($streakInfo)): ?>
        <script>
            window.streakInfo = <?php echo json_encode($streakInfo); ?>;
        </script>
        <?php endif; ?>
        <script src="/public/scripts/streak.js"></script>
    </main>
    <nav class="bottom mobile-only anchor">
        <ul>
            <li class="mobile-only"><a href="/dashboard">Swipe<span class="material-symbols-outlined">home</span></a></li>
            <li class="mobile-only"><a href="/quests">Quests<span class="material-symbols-outlined">trophy</span></a></li>
            <li class="mobile-only"><a href="/leaders">Leaders<span class="material-symbols-outlined">leaderboard</span></a></li>
            <li class="mobile-only"><a href="/upload">Upload<span class="material-symbols-outlined">upload</span></a></li>
            <li class="mobile-only"><a href="/profile">Profile<span class="material-symbols-outlined">person</span></a></li>
        </ul>
    </nav>
</body>
</html>