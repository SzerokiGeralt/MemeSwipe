<!DOCTYPE html>
<html>
<head>
    <title>Edit Profile</title>
    <link rel="stylesheet" type="text/css" href="/public/styles/main.css">
    <link rel="stylesheet" type="text/css" href="/public/styles/profile.css">
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <nav class="top desktop-only anchor">
        <ul class="left">
        <?php if (isset($_SESSION['user_id'])): ?>
            <li>Lvl <?php echo htmlspecialchars($stats['level'] ?? 'N/A'); ?> <meter min="0" max="1" value="<?php echo ($stats['expPercentage'] ?? 0); ?>"></meter></li>
            <li><?php echo number_format($stats['diamonds'] ?? 0); ?> ðŸ’Ž</li>
            <li><?php echo $stats['streak'] ?? 0; ?> <?php echo ($stats['streakActive'] ?? false) ? 'ðŸ”¥' : 'ðŸ§Š'; ?></li>
        <?php endif; ?>
        </ul>
        <ul class="right">
            <li><a href="/dashboard">Swipe<span class="material-symbols-outlined">home</span></a></li>
            <li><a href="/quests">Quests<span class="material-symbols-outlined">trophy</span></a></li>
            <li><a href="/leaders">Leaders<span class="material-symbols-outlined">leaderboard</span></a></li>
            <li><a href="/upload">Upload<span class="material-symbols-outlined">upload</span></a></li>
            <li><a href="/profile">Profile<span class="material-symbols-outlined">person</span></a></li>
        </ul>
    </nav>
    <nav class="top mobile-only anchor">
        <ul>
            <?php if (isset($_SESSION['user_id'])): ?>
            <li>Lvl <?php echo htmlspecialchars($stats['level'] ?? 'N/A'); ?> <meter min="0" max="1" value="<?php echo ($stats['expPercentage'] ?? 0); ?>"></meter></li>
            <li><?php echo number_format($stats['diamonds'] ?? 0); ?> ðŸ’Ž</li>
            <li><?php echo $stats['streak'] ?? 0; ?> <?php echo ($stats['streakActive'] ?? false) ? 'ðŸ”¥' : 'ðŸ§Š'; ?></li>
            <?php endif; ?>
        </ul>
    </nav>
    <main class="scrollable">
        <div class="edit-profile-container">
            <h1>Edit Profile</h1>
            
            <?php if (isset($messages)): ?>
                <div class="error-message">
                    <?php echo htmlspecialchars($messages); ?>
                </div>
            <?php endif; ?>
            
            <form method="POST" action="/profile/update" enctype="multipart/form-data" class="edit-profile-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" value="<?php echo htmlspecialchars($user['username'] ?? ''); ?>" required>
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" value="<?php echo htmlspecialchars($user['email'] ?? ''); ?>" required>
                </div>
                
                <div class="form-group">
                    <label for="profile_photo">Profile Photo</label>
                    <input type="file" id="profile_photo" name="profile_photo" accept="image/jpeg,image/png,image/jpg,image/webp">
                    <small>Upload a new profile photo (Max 5MB, JPEG/PNG/WebP). Leave empty to keep current photo.</small>
                </div>
                
                <div class="password-section">
                    <h2>Change Password</h2>
                    <p class="password-note">Leave blank if you don't want to change your password</p>
                    
                    <div class="form-group">
                        <label for="current_password">Current Password</label>
                        <input type="password" id="current_password" name="current_password" placeholder="Enter current password">
                    </div>
                    
                    <div class="form-group">
                        <label for="new_password">New Password</label>
                        <input type="password" id="new_password" name="new_password" placeholder="Enter new password">
                        <small>Minimum 6 characters</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirm_password">Confirm New Password</label>
                        <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm new password">
                    </div>
                </div>
                
                <div class="profile-photo-preview">
                    <label>Current Profile Photo:</label>
                    <img src="<?php echo htmlspecialchars($user['profile_photo'] ?? 'https://picsum.photos/150/150'); ?>" alt="Profile Photo" id="preview-image">
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-save">Save Changes</button>
                    <a href="/profile" class="btn-cancel">Cancel</a>
                </div>
            </form>
        </div>
        
        <script>
            // Preview profile photo on file selection
            document.getElementById('profile_photo').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const preview = document.getElementById('preview-image');
                
                if (file) {
                    // Validate file size (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File too large! Maximum size is 5MB.');
                        this.value = '';
                        return;
                    }
                    
                    // Validate file type
                    const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'];
                    if (!validTypes.includes(file.type)) {
                        alert('Invalid file type! Please select a JPEG, PNG, or WebP image.');
                        this.value = '';
                        return;
                    }
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
        </script>

        <!-- Streak Extended Popup -->
        <div id="streakExtendedPopup" class="popup-overlay">
            <div class="popup-content streak-success">
                <div class="popup-icon">ðŸ”¥</div>
                <h2>STREAK EXTENDED!</h2>
                <p id="streakExtendedMessage">Your streak is now 5 days!</p>
                <p class="streak-bonus">Keep it up!</p>
                <button id="streakExtendedClose" class="popup-btn">Nice!</button>
            </div>
        </div>

        <!-- Streak Lost Popup -->
        <div id="streakLostPopup" class="popup-overlay">
            <div class="popup-content streak-lost">
                <div class="popup-icon">ðŸ§Š</div>
                <h2>STREAK LOST!</h2>
                <p id="streakLostMessage">You lost your 7 day streak...</p>
                <p class="streak-restart">Starting fresh with day 1!</p>
                <button id="streakLostClose" class="popup-btn">Start Again</button>
            </div>
        </div>

        <!-- New Streak Popup -->
        <div id="newStreakPopup" class="popup-overlay">
            <div class="popup-content streak-new">
                <div class="popup-icon">âœ¨</div>
                <h2>WELCOME!</h2>
                <p id="newStreakMessage">Your streak begins today!</p>
                <p class="streak-tip">Come back tomorrow to keep it going!</p>
                <button id="newStreakClose" class="popup-btn">Let's Go!</button>
            </div>
        </div>

        <?php if (isset($streakInfo)): ?>
        <script>
            window.streakInfo = <?php echo json_encode($streakInfo); ?>;
        </script>
        <?php endif; ?>
        <script src="/public/scripts/streak.js"></script>
    </main>
    <nav class="bottom mobile-only anchor">
        <ul>
            <li class="mobile-only"><a href="/dashboard">Swipe<span class="material-symbols-outlined">home</span></a></li>
            <li class="mobile-only"><a href="/quests">Quests<span class="material-symbols-outlined">trophy</span></a></li>
            <li class="mobile-only"><a href="/leaders">Leaders<span class="material-symbols-outlined">leaderboard</span></a></li>
            <li class="mobile-only"><a href="/upload">Upload<span class="material-symbols-outlined">upload</span></a></li>
            <li class="mobile-only"><a href="/profile">Profile<span class="material-symbols-outlined">person</span></a></li>
        </ul>
    </nav>
</body>
</html>
