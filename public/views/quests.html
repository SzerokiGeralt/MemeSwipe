<!DOCTYPE html>
<html>
<head>
    <title>Quests</title>
    <link rel="stylesheet" type="text/css" href="/public/styles/main.css">
    <link rel="stylesheet" type="text/css" href="/public/styles/quests.css">
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <nav class="top desktop-only anchor">
        <ul class="left">
        <?php if (isset($_SESSION['user_id'])): ?>
            <li>Lvl <?php echo htmlspecialchars($stats['level'] ?? 'N/A'); ?> <meter id="disk_d" value="<?php echo ($stats['expPercentage'] ?? 0); ?>"></meter></li>
            <li><?php echo number_format($stats['diamonds'] ?? 0); ?> üíé</li>
            <li><?php echo $stats['streak'] ?? 0; ?> <?php echo ($stats['streakActive'] ?? false) ? 'üî•' : 'üßä'; ?></li>
        <?php endif; ?>
        </ul>
        <ul class="right">
            <li><a href="/dashboard">Swipe<span class="material-symbols-outlined">home</span></a></li>
            <li><a href="/quests">Quests<span class="material-symbols-outlined">trophy</span></a></li>
            <li><a href="/leaders">Leaders<span class="material-symbols-outlined">leaderboard</span></a></li>
            <li><a href="/upload">Upload<span class="material-symbols-outlined">upload</span></a></li>
            <li><a href="/profile">Profile<span class="material-symbols-outlined">person</span></a></li>
        </ul>
    </nav>
    <nav class="top mobile-only anchor">
        <ul>
        <?php if (isset($_SESSION['user_id'])): ?>
            <li>Lvl <?php echo htmlspecialchars($stats['level'] ?? 'N/A'); ?> <meter id="disk_d" value="<?php echo ($stats['expPercentage'] ?? 0); ?>"></meter></li>
            <li><?php echo number_format($stats['diamonds'] ?? 0); ?> üíé</li>
            <li><?php echo $stats['streak'] ?? 0; ?> <?php echo ($stats['streakActive'] ?? false) ? 'üî•' : 'üßä'; ?></li>
        <?php endif; ?>
        </ul>
    </nav>
    <main class="scrollable">
        <div class="selection-bar">
            <button class="tab-button active" data-tab="quests">Quests</button>
            <button class="tab-button" data-tab="store">Store</button>
        </div>
        
        <div class="tab-content quests active">
            <div class="quests-header">
                <h2>Weekly Quests</h2>
                <div class="reset-timer">
                    <span class="reset-label">Resets in:</span>
                    <span id="resetCountdown" class="countdown">
                        <?php echo ($resetInfo['days'] ?? 0); ?>d <?php echo ($resetInfo['hours'] ?? 0); ?>h <?php echo ($resetInfo['minutes'] ?? 0); ?>m
                    </span>
                </div>
            </div>
            <div class="quests-grid">
                <?php if (!empty($quests)): ?>
                    <?php foreach ($quests as $quest): ?>
                        <?php 
                            $progress = $quest['progress'] ?? 0;
                            $count = $quest['count'];
                            $isCompleted = $quest['completed'] == true || $quest['completed'] == 't';
                            $progressPercent = min(100, ($progress / $count) * 100);
                            $canClaim = $progress >= $count && !$isCompleted;
                        ?>
                        <div class="quest-item <?php echo $isCompleted ? 'completed' : ($canClaim ? 'claimable' : ''); ?>">
                            <div class="quest-header">
                                <img src="<?php echo htmlspecialchars($quest['icon']); ?>" alt="" class="quest-icon-img">
                                <h3><?php echo htmlspecialchars($quest['name']); ?></h3>
                            </div>
                            <p class="quest-description"><?php echo htmlspecialchars($quest['description']); ?></p>
                            <div class="quest-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: <?php echo $progressPercent; ?>%;"></div>
                                </div>
                                <span class="progress-text"><?php echo $progress; ?>/<?php echo $count; ?></span>
                            </div>
                            <div class="quest-reward">
                                <?php if ($isCompleted): ?>
                                    <span class="claimed">‚úì Claimed: <?php echo number_format($quest['reward']); ?> üíé</span>
                                <?php elseif ($canClaim): ?>
                                    <button class="claim-btn" data-quest-id="<?php echo $quest['id']; ?>">
                                        Claim <?php echo number_format($quest['reward']); ?> üíé
                                    </button>
                                <?php else: ?>
                                    <span>Reward: <?php echo number_format($quest['reward']); ?> üíé</span>
                                <?php endif; ?>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p class="no-quests">No quests available. Check back later!</p>
                <?php endif; ?>
            </div>
        </div>

        <div class="tab-content store">
            <h2>Diamond Store</h2>
            <div class="store-grid">
                <?php if (!empty($items)): ?>
                    <?php foreach ($items as $item): ?>
                        <?php 
                            // Check if item can be bought infinitely (max_quantity = 0)
                            $canBuyInfinitely = $item['max_quantity'] == 0;
                            // Check if user already owns this item
                            $alreadyOwned = $item['owned_by_user'] == 't' || $item['owned_by_user'] === true;
                            // Check if user can afford this item
                            $canAfford = ($stats['diamonds'] ?? 0) >= $item['cost'];
                            // Disable button if item is limited and already owned OR if user can't afford it
                            $isOwned = !$canBuyInfinitely && $alreadyOwned;
                            $isDisabled = $isOwned || !$canAfford;
                            $itemClass = $isOwned ? 'owned' : (!$canAfford ? 'cannot-afford' : '');
                        ?>
                        <div class="store-item <?php echo $itemClass; ?>">
                            <img src="<?php echo htmlspecialchars($item['icon']); ?>" alt="<?php echo htmlspecialchars($item['name']); ?>">
                            <h3><?php echo htmlspecialchars($item['name']); ?></h3>
                            <p><?php echo htmlspecialchars($item['description']); ?></p>
                            <div class="item-price">
                                <span class="price"><?php echo number_format($item['cost']); ?> üíé</span>
                                <?php if ($isOwned): ?>
                                    <button class="buy-btn" disabled>Owned</button>
                                <?php elseif (!$canAfford): ?>
                                    <button class="buy-btn" disabled>Can't Afford</button>
                                <?php else: ?>
                                    <button class="buy-btn" data-item-id="<?php echo $item['id']; ?>">Buy</button>
                                <?php endif; ?>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p>No items available at the moment.</p>
                <?php endif; ?>
            </div>
        </div>

        <!-- Purchase Popup -->
        <div id="purchasePopup" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-icon">üéâ</div>
                <h2 id="popupTitle">Purchase Successful!</h2>
                <p id="popupMessage">Item purchased successfully!</p>
                <button id="popupClose" class="popup-btn">OK</button>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        tabContents.forEach(content => content.classList.remove('active'));
                        
                        this.classList.add('active');
                        document.querySelector('.tab-content.' + targetTab).classList.add('active');
                    });
                });

                // Quest claim handling
                const claimButtons = document.querySelectorAll('.claim-btn');
                const popup = document.getElementById('purchasePopup');
                const popupTitle = document.getElementById('popupTitle');
                const popupMessage = document.getElementById('popupMessage');
                const popupIcon = document.querySelector('.popup-icon');
                const popupClose = document.getElementById('popupClose');
                
                claimButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const questId = this.getAttribute('data-quest-id');
                        if (!questId) return;
                        
                        const btn = this;
                        btn.disabled = true;
                        const originalText = btn.textContent;
                        btn.textContent = 'Claiming...';
                        
                        fetch('/quests/claim', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ quest_id: parseInt(questId) })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                popupIcon.textContent = 'üéâ';
                                popupTitle.textContent = 'Quest Completed!';
                                popupMessage.textContent = data.message;
                                popup.classList.add('show');
                                
                                setTimeout(function() {
                                    location.reload();
                                }, 2000);
                            } else {
                                popupIcon.textContent = '‚ùå';
                                popupTitle.textContent = 'Error';
                                popupMessage.textContent = data.message;
                                popup.classList.add('show');
                                
                                btn.disabled = false;
                                btn.textContent = originalText;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            popupIcon.textContent = '‚ùå';
                            popupTitle.textContent = 'Error';
                            popupMessage.textContent = 'Something went wrong. Please try again.';
                            popup.classList.add('show');
                            
                            btn.disabled = false;
                            btn.textContent = originalText;
                        });
                    });
                });

                // Purchase handling
                const buyButtons = document.querySelectorAll('.buy-btn:not([disabled])');

                // Close popup when clicking OK button
                popupClose.addEventListener('click', function() {
                    popup.classList.remove('show');
                });

                // Close popup when clicking outside
                popup.addEventListener('click', function(e) {
                    if (e.target === popup) {
                        popup.classList.remove('show');
                    }
                });

                buyButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const itemId = this.getAttribute('data-item-id');
                        if (!itemId) return;

                        const btn = this;
                        // Disable button during purchase
                        btn.disabled = true;
                        const originalText = btn.textContent;
                        btn.textContent = 'Processing...';

                        // Send purchase request
                        fetch('/quests/purchase', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ item_id: parseInt(itemId) })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Show success popup
                                popupIcon.textContent = 'üéâ';
                                popupTitle.textContent = 'Purchase Successful!';
                                popupMessage.textContent = data.message;
                                popup.classList.add('show');

                                // Reload page after short delay to update stats and owned items
                                setTimeout(function() {
                                    location.reload();
                                }, 2000);
                            } else {
                                // Show error popup
                                popupIcon.textContent = '‚ùå';
                                popupTitle.textContent = 'Purchase Failed';
                                popupMessage.textContent = data.message;
                                popup.classList.add('show');

                                // Re-enable button
                                btn.disabled = false;
                                btn.textContent = originalText;
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            popupIcon.textContent = '‚ùå';
                            popupTitle.textContent = 'Error';
                            popupMessage.textContent = 'Something went wrong. Please try again.';
                            popup.classList.add('show');

                            btn.disabled = false;
                            btn.textContent = originalText;
                        });
                    });
                });
                
                // Reset countdown timer
                const resetCountdown = document.getElementById('resetCountdown');
                if (resetCountdown) {
                    let totalSeconds = <?php echo ($resetInfo['total_seconds'] ?? 0); ?>;
                    
                    function updateCountdown() {
                        if (totalSeconds <= 0) {
                            resetCountdown.textContent = 'Resetting...';
                            setTimeout(() => location.reload(), 1000);
                            return;
                        }
                        
                        const days = Math.floor(totalSeconds / 86400);
                        const hours = Math.floor((totalSeconds % 86400) / 3600);
                        const minutes = Math.floor((totalSeconds % 3600) / 60);
                        
                        resetCountdown.textContent = `${days}d ${hours}h ${minutes}m`;
                        totalSeconds--;
                    }
                    
                    setInterval(updateCountdown, 60000); // Update every minute
                }
            });
        </script>
    </main>
        <nav class="bottom mobile-only anchor">
        <ul>
            <li class="mobile-only"><a href="/dashboard">Swipe<span class="material-symbols-outlined">home</span></a></li>
            <li class="mobile-only"><a href="/quests">Quests<span class="material-symbols-outlined">trophy</span></a></li>
            <li class="mobile-only"><a href="/leaders">Leaders<span class="material-symbols-outlined">leaderboard</span></a></li>
            <li class="mobile-only"><a href="/upload">Upload<span class="material-symbols-outlined">upload</span></a></li>
            <li class="mobile-only"><a href="/profile">Profile<span class="material-symbols-outlined">person</span></a></li>
        </ul>
    </nav>
</body>
</html>