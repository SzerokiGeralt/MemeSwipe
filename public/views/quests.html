<!DOCTYPE html>
<html>
<head>
    <title>Quests</title>
    <link rel="stylesheet" type="text/css" href="/public/styles/main.css">
    <link rel="stylesheet" type="text/css" href="/public/styles/quests.css">
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <nav class="top desktop-only anchor">
        <ul class="left">
        <?php if (isset($_SESSION['user_id'])): ?>
            <li>Lvl <?php echo htmlspecialchars($stats['level'] ?? 'N/A'); ?> <meter min="0" max="1" value="<?php echo ($stats['expPercentage'] ?? 0); ?>"></meter></li>
            <li><?php echo number_format($stats['diamonds'] ?? 0); ?> ðŸ’Ž</li>
            <li><?php echo $stats['streak'] ?? 0; ?> <?php echo ($stats['streakActive'] ?? false) ? 'ðŸ”¥' : 'ðŸ§Š'; ?></li>
        <?php endif; ?>
        </ul>
        <ul class="right">
            <li><a href="/dashboard">Swipe<span class="material-symbols-outlined">home</span></a></li>
            <li><a href="/quests">Quests<span class="material-symbols-outlined">trophy</span></a></li>
            <li><a href="/leaders">Leaders<span class="material-symbols-outlined">leaderboard</span></a></li>
            <li><a href="/upload">Upload<span class="material-symbols-outlined">upload</span></a></li>
            <li><a href="/profile">Profile<span class="material-symbols-outlined">person</span></a></li>
        </ul>
    </nav>
    <nav class="top mobile-only anchor">
        <ul>
        <?php if (isset($_SESSION['user_id'])): ?>
            <li>Lvl <?php echo htmlspecialchars($stats['level'] ?? 'N/A'); ?> <meter min="0" max="1" value="<?php echo ($stats['expPercentage'] ?? 0); ?>"></meter></li>
            <li><?php echo number_format($stats['diamonds'] ?? 0); ?> ðŸ’Ž</li>
            <li><?php echo $stats['streak'] ?? 0; ?> <?php echo ($stats['streakActive'] ?? false) ? 'ðŸ”¥' : 'ðŸ§Š'; ?></li>
        <?php endif; ?>
        </ul>
    </nav>
    <main class="scrollable">
        <div class="selection-bar">
            <button class="tab-button active" data-tab="quests">Quests</button>
            <button class="tab-button" data-tab="store">Store</button>
        </div>
        
        <div class="tab-content quests active">
            <div class="quests-header">
                <h2>Weekly Quests</h2>
                <div class="reset-timer">
                    <span class="reset-label">Resets in:</span>
                    <span id="resetCountdown" class="countdown">
                        <?php echo ($resetInfo['days'] ?? 0); ?>d <?php echo ($resetInfo['hours'] ?? 0); ?>h <?php echo ($resetInfo['minutes'] ?? 0); ?>m
                    </span>
                </div>
            </div>
            <div class="quests-grid">
                <?php if (!empty($quests)): ?>
                    <?php foreach ($quests as $quest): ?>
                        <?php 
                            $progress = $quest['progress'] ?? 0;
                            $count = $quest['count'];
                            $isCompleted = $quest['completed'] == true || $quest['completed'] == 't';
                            $progressPercent = min(100, ($progress / $count) * 100);
                            $canClaim = $progress >= $count && !$isCompleted;
                        ?>
                        <div class="quest-item <?php echo $isCompleted ? 'completed' : ($canClaim ? 'claimable' : ''); ?>">
                            <div class="quest-header">
                                <img src="<?php echo htmlspecialchars($quest['icon']); ?>" alt="" class="quest-icon-img">
                                <h3><?php echo htmlspecialchars($quest['name']); ?></h3>
                            </div>
                            <p class="quest-description"><?php echo htmlspecialchars($quest['description']); ?></p>
                            <div class="quest-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: <?php echo $progressPercent; ?>%;"></div>
                                </div>
                                <span class="progress-text"><?php echo $progress; ?>/<?php echo $count; ?></span>
                            </div>
                            <div class="quest-reward">
                                <?php if ($isCompleted): ?>
                                    <span class="claimed">âœ“ Claimed: <?php echo number_format($quest['reward']); ?> ðŸ’Ž</span>
                                <?php elseif ($canClaim): ?>
                                    <button class="claim-btn" data-quest-id="<?php echo $quest['id']; ?>">
                                        Claim <?php echo number_format($quest['reward']); ?> ðŸ’Ž
                                    </button>
                                <?php else: ?>
                                    <span>Reward: <?php echo number_format($quest['reward']); ?> ðŸ’Ž</span>
                                <?php endif; ?>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p class="no-quests">No quests available. Check back later!</p>
                <?php endif; ?>
            </div>
        </div>

        <div class="tab-content store">
            <h2>Diamond Store</h2>
            <div class="store-grid">
                <?php if (!empty($items)): ?>
                    <?php foreach ($items as $item): ?>
                        <?php 
                            // Check if item can be bought infinitely (max_quantity = 0)
                            $canBuyInfinitely = $item['max_quantity'] == 0;
                            // Check if user already owns this item
                            $alreadyOwned = $item['owned_by_user'] == 't' || $item['owned_by_user'] === true;
                            // Check if user can afford this item
                            $canAfford = ($stats['diamonds'] ?? 0) >= $item['cost'];
                            // Disable button if item is limited and already owned OR if user can't afford it
                            $isOwned = !$canBuyInfinitely && $alreadyOwned;
                            $isDisabled = $isOwned || !$canAfford;
                            $itemClass = $isOwned ? 'owned' : (!$canAfford ? 'cannot-afford' : '');
                        ?>
                        <div class="store-item <?php echo $itemClass; ?>">
                            <img src="<?php echo htmlspecialchars($item['icon']); ?>" alt="<?php echo htmlspecialchars($item['name']); ?>">
                            <h3><?php echo htmlspecialchars($item['name']); ?></h3>
                            <p><?php echo htmlspecialchars($item['description']); ?></p>
                            <div class="item-price">
                                <span class="price"><?php echo number_format($item['cost']); ?> ðŸ’Ž</span>
                                <?php if ($isOwned): ?>
                                    <button class="buy-btn" disabled>Owned</button>
                                <?php elseif (!$canAfford): ?>
                                    <button class="buy-btn" disabled>Can't Afford</button>
                                <?php else: ?>
                                    <button class="buy-btn" data-item-id="<?php echo $item['id']; ?>">Buy</button>
                                <?php endif; ?>
                            </div>
                        </div>
                    <?php endforeach; ?>
                <?php else: ?>
                    <p>No items available at the moment.</p>
                <?php endif; ?>
            </div>
        </div>

        <!-- Purchase Popup -->
        <div id="purchasePopup" class="popup-overlay">
            <div class="popup-content">
                <div class="popup-icon">ðŸŽ‰</div>
                <h2 id="popupTitle">Purchase Successful!</h2>
                <p id="popupMessage">Item purchased successfully!</p>
                <button id="popupClose" class="popup-btn">OK</button>
            </div>
        </div>

        <!-- Streak Extended Popup -->
        <div id="streakExtendedPopup" class="popup-overlay">
            <div class="popup-content streak-success">
                <div class="popup-icon">ðŸ”¥</div>
                <h2>STREAK EXTENDED!</h2>
                <p id="streakExtendedMessage">Your streak is now 5 days!</p>
                <p class="streak-bonus">Keep it up!</p>
                <button id="streakExtendedClose" class="popup-btn">Nice!</button>
            </div>
        </div>

        <!-- Streak Lost Popup -->
        <div id="streakLostPopup" class="popup-overlay">
            <div class="popup-content streak-lost">
                <div class="popup-icon">ðŸ§Š</div>
                <h2>STREAK LOST!</h2>
                <p id="streakLostMessage">You lost your 7 day streak...</p>
                <p class="streak-restart">Starting fresh with day 1!</p>
                <button id="streakLostClose" class="popup-btn">Start Again</button>
            </div>
        </div>

        <!-- New Streak Popup -->
        <div id="newStreakPopup" class="popup-overlay">
            <div class="popup-content streak-new">
                <div class="popup-icon">âœ¨</div>
                <h2>WELCOME!</h2>
                <p id="newStreakMessage">Your streak begins today!</p>
                <p class="streak-tip">Come back tomorrow to keep it going!</p>
                <button id="newStreakClose" class="popup-btn">Let's Go!</button>
            </div>
        </div>

        <script src="/public/scripts/quests.js"></script>
        <?php if (isset($streakInfo)): ?>
        <script>
            window.streakInfo = <?php echo json_encode($streakInfo); ?>;
        </script>
        <?php endif; ?>
        <script src="/public/scripts/streak.js"></script>
    </main>
        <nav class="bottom mobile-only anchor">
        <ul>
            <li class="mobile-only"><a href="/dashboard">Swipe<span class="material-symbols-outlined">home</span></a></li>
            <li class="mobile-only"><a href="/quests">Quests<span class="material-symbols-outlined">trophy</span></a></li>
            <li class="mobile-only"><a href="/leaders">Leaders<span class="material-symbols-outlined">leaderboard</span></a></li>
            <li class="mobile-only"><a href="/upload">Upload<span class="material-symbols-outlined">upload</span></a></li>
            <li class="mobile-only"><a href="/profile">Profile<span class="material-symbols-outlined">person</span></a></li>
        </ul>
    </nav>
</body>
</html>